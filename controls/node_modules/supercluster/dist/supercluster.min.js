!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Supercluster=e()}(this,function(){"use strict";function t(o,n,r,i,s,a){if(!(s-i<=r)){var u=i+s>>1;!function t(o,n,r,i,s,a){for(;s>i;){if(s-i>600){var u=s-i+1,p=r-i+1,h=Math.log(u),f=.5*Math.exp(2*h/3),l=.5*Math.sqrt(h*f*(u-f)/u)*(p-u/2<0?-1:1),d=Math.max(i,Math.floor(r-p*f/u+l)),c=Math.min(s,Math.floor(r+(u-p)*f/u+l));t(o,n,r,d,c,a)}var m=n[2*r+a],v=i,g=s;for(e(o,n,i,r),n[2*s+a]>m&&e(o,n,i,s);v<g;){for(e(o,n,v,g),v++,g--;n[2*v+a]<m;)v++;for(;n[2*g+a]>m;)g--}n[2*i+a]===m?e(o,n,i,g):e(o,n,++g,s),g<=r&&(i=g+1),r<=g&&(s=g-1)}}(o,n,u,i,s,a%2),t(o,n,r,i,u-1,a+1),t(o,n,r,u+1,s,a+1)}}function e(t,e,n,r){o(t,n,r),o(e,2*n,2*r),o(e,2*n+1,2*r+1)}function o(t,e,o){var n=t[e];t[e]=t[o],t[o]=n}function n(t,e,o,n){var r=t-o,i=e-n;return r*r+i*i}var r=function(t){return t[0]},i=function(t){return t[1]},s=function(e,o,n,s,a){void 0===o&&(o=r),void 0===n&&(n=i),void 0===s&&(s=64),void 0===a&&(a=Float64Array),this.nodeSize=s,this.points=e;for(var u=e.length<65536?Uint16Array:Uint32Array,p=this.ids=new u(e.length),h=this.coords=new a(2*e.length),f=0;f<e.length;f++)p[f]=f,h[2*f]=o(e[f]),h[2*f+1]=n(e[f]);t(p,h,s,0,p.length-1,0)};s.prototype.range=function(t,e,o,n){return function(t,e,o,n,r,i,s){for(var a,u,p=[0,t.length-1,0],h=[];p.length;){var f=p.pop(),l=p.pop(),d=p.pop();if(l-d<=s)for(var c=d;c<=l;c++)a=e[2*c],u=e[2*c+1],a>=o&&a<=r&&u>=n&&u<=i&&h.push(t[c]);else{var m=Math.floor((d+l)/2);a=e[2*m],u=e[2*m+1],a>=o&&a<=r&&u>=n&&u<=i&&h.push(t[m]);var v=(f+1)%2;(0===f?o<=a:n<=u)&&(p.push(d),p.push(m-1),p.push(v)),(0===f?r>=a:i>=u)&&(p.push(m+1),p.push(l),p.push(v))}}return h}(this.ids,this.coords,t,e,o,n,this.nodeSize)},s.prototype.within=function(t,e,o){return function(t,e,o,r,i,s){for(var a=[0,t.length-1,0],u=[],p=i*i;a.length;){var h=a.pop(),f=a.pop(),l=a.pop();if(f-l<=s)for(var d=l;d<=f;d++)n(e[2*d],e[2*d+1],o,r)<=p&&u.push(t[d]);else{var c=Math.floor((l+f)/2),m=e[2*c],v=e[2*c+1];n(m,v,o,r)<=p&&u.push(t[c]);var g=(h+1)%2;(0===h?o-i<=m:r-i<=v)&&(a.push(l),a.push(c-1),a.push(g)),(0===h?o+i>=m:r+i>=v)&&(a.push(c+1),a.push(f),a.push(g))}}return u}(this.ids,this.coords,t,e,o,this.nodeSize)};var a={minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!1,reduce:null,initial:function(){return{}},map:function(t){return t}},u=function(t){this.options=m(Object.create(a),t),this.trees=new Array(this.options.maxZoom+1)};function p(t,e,o,n,r){return{x:t,y:e,zoom:1/0,id:o,parentId:-1,numPoints:n,properties:r}}function h(t,e){var o=t.geometry.coordinates,n=o[0],r=o[1];return{x:d(n),y:c(r),zoom:1/0,index:e,parentId:-1}}function f(t){return{type:"Feature",id:t.id,properties:l(t),geometry:{type:"Point",coordinates:[(n=t.x,360*(n-.5)),(e=t.y,o=(180-360*e)*Math.PI/180,360*Math.atan(Math.exp(o))/Math.PI-90)]}};var e,o,n}function l(t){var e=t.numPoints,o=e>=1e4?Math.round(e/1e3)+"k":e>=1e3?Math.round(e/100)/10+"k":e;return m(m({},t.properties),{cluster:!0,cluster_id:t.id,point_count:e,point_count_abbreviated:o})}function d(t){return t/360+.5}function c(t){var e=Math.sin(t*Math.PI/180),o=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return o<0?0:o>1?1:o}function m(t,e){for(var o in e)t[o]=e[o];return t}function v(t){return t.x}function g(t){return t.y}return u.prototype.load=function(t){var e=this.options,o=e.log,n=e.minZoom,r=e.maxZoom,i=e.nodeSize;o&&console.time("total time");var a="prepare "+t.length+" points";o&&console.time(a),this.points=t;for(var u=[],p=0;p<t.length;p++)t[p].geometry&&u.push(h(t[p],p));this.trees[r+1]=new s(u,v,g,i,Float32Array),o&&console.timeEnd(a);for(var f=r;f>=n;f--){var l=+Date.now();u=this._cluster(u,f),this.trees[f]=new s(u,v,g,i,Float32Array),o&&console.log("z%d: %d clusters in %dms",f,u.length,+Date.now()-l)}return o&&console.timeEnd("total time"),this},u.prototype.getClusters=function(t,e){var o=((t[0]+180)%360+360)%360-180,n=Math.max(-90,Math.min(90,t[1])),r=180===t[2]?180:((t[2]+180)%360+360)%360-180,i=Math.max(-90,Math.min(90,t[3]));if(t[2]-t[0]>=360)o=-180,r=180;else if(o>r){var s=this.getClusters([o,n,180,i],e),a=this.getClusters([-180,n,r,i],e);return s.concat(a)}for(var u=this.trees[this._limitZoom(e)],p=[],h=0,l=u.range(d(o),c(i),d(r),c(n));h<l.length;h+=1){var m=l[h],v=u.points[m];p.push(v.numPoints?f(v):this.points[v.index])}return p},u.prototype.getChildren=function(t){var e=t>>5,o=t%32,n="No cluster with the specified id.",r=this.trees[o];if(!r)throw new Error(n);var i=r.points[e];if(!i)throw new Error(n);for(var s=this.options.radius/(this.options.extent*Math.pow(2,o-1)),a=[],u=0,p=r.within(i.x,i.y,s);u<p.length;u+=1){var h=p[u],l=r.points[h];l.parentId===t&&a.push(l.numPoints?f(l):this.points[l.index])}if(0===a.length)throw new Error(n);return a},u.prototype.getLeaves=function(t,e,o){e=e||10,o=o||0;var n=[];return this._appendLeaves(n,t,e,o,0),n},u.prototype.getTile=function(t,e,o){var n=this.trees[this._limitZoom(t)],r=Math.pow(2,t),i=this.options,s=i.extent,a=i.radius/s,u=(o-a)/r,p=(o+1+a)/r,h={features:[]};return this._addTileFeatures(n.range((e-a)/r,u,(e+1+a)/r,p),n.points,e,o,r,h),0===e&&this._addTileFeatures(n.range(1-a/r,u,1,p),n.points,r,o,r,h),e===r-1&&this._addTileFeatures(n.range(0,u,a/r,p),n.points,-1,o,r,h),h.features.length?h:null},u.prototype.getClusterExpansionZoom=function(t){for(var e=t%32-1;e<=this.options.maxZoom;){var o=this.getChildren(t);if(e++,1!==o.length)break;t=o[0].properties.cluster_id}return e},u.prototype._appendLeaves=function(t,e,o,n,r){for(var i=0,s=this.getChildren(e);i<s.length;i+=1){var a=s[i],u=a.properties;if(u&&u.cluster?r+u.point_count<=n?r+=u.point_count:r=this._appendLeaves(t,u.cluster_id,o,n,r):r<n?r++:t.push(a),t.length===o)break}return r},u.prototype._addTileFeatures=function(t,e,o,n,r,i){for(var s=0,a=t;s<a.length;s+=1){var u=e[a[s]],p={type:1,geometry:[[Math.round(this.options.extent*(u.x*r-o)),Math.round(this.options.extent*(u.y*r-n))]],tags:u.numPoints?l(u):this.points[u.index].properties},h=u.numPoints?u.id:this.points[u.index].id;void 0!==h&&(p.id=h),i.features.push(p)}},u.prototype._limitZoom=function(t){return Math.max(this.options.minZoom,Math.min(t,this.options.maxZoom+1))},u.prototype._cluster=function(t,e){for(var o=[],n=this.options,r=n.radius,i=n.extent,s=n.reduce,a=n.initial,u=r/(i*Math.pow(2,e)),h=0;h<t.length;h++){var f=t[h];if(!(f.zoom<=e)){f.zoom=e;var l=this.trees[e+1],d=l.within(f.x,f.y,u),c=f.numPoints||1,m=f.x*c,v=f.y*c,g=null;s&&(g=a(),this._accumulate(g,f));for(var y=(h<<5)+(e+1),x=0,M=d;x<M.length;x+=1){var _=M[x],w=l.points[_];if(!(w.zoom<=e)){w.zoom=e;var P=w.numPoints||1;m+=w.x*P,v+=w.y*P,c+=P,w.parentId=y,s&&this._accumulate(g,w)}}1===c?o.push(f):(f.parentId=y,o.push(p(m/c,v/c,y,c,g)))}}return o},u.prototype._accumulate=function(t,e){var o=this.options,n=o.map;(0,o.reduce)(t,e.numPoints?e.properties:n(this.points[e.index].properties))},u});
